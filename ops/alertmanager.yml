global:
  resolve_timeout: 5m
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

templates:
  - '/etc/alertmanager/templates/*.tmpl'

route:
  receiver: 'default'
  group_by: ['alertname', 'instance', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h

  routes:
    # CRITIQUES: PagerDuty + Slack + Email
    - match:
        severity: critical
      receiver: 'critical'
      group_wait: 5s
      repeat_interval: 5m
      continue: false

    # SSL Alerts: Email (24h r√©p√©tition)
    - match:
        component: ssl
      receiver: 'ssl-team'
      group_wait: 1s
      repeat_interval: 24h
      continue: false

    # Pr√©production: Slack seulement
    - match:
        environment: preprod
      receiver: 'preprod-team'
      group_wait: 30s
      continue: false

    # Warnings: Slack standard
    - match:
        severity: warning
      receiver: 'ops-team'
      group_wait: 30s
      continue: false

    # Info: Slack (pas d'escalade)
    - match:
        severity: info
      receiver: 'info-channel'
      group_wait: 1m
      continue: false

receivers:
  # ===== CRITICAL (PagerDuty + Slack + Email) =====
  - name: critical
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#critical-alerts'
        title: 'üö® ALERTE CRITIQUE PROD'
        text: |
          Service: {{ .GroupLabels.service }}
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        actions:
          - type: button
            text: 'Voir dans Grafana'
            url: 'https://grafana.exam.meetly.ovh'
          - type: button
            text: 'Voir dans Prometheus'
            url: 'https://prometheus.exam.meetly.ovh'

    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        description: '{{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
        details:
          firing: '{{ range .Alerts.Firing }}{{ .Annotations.summary }}\n{{ end }}'
          resolved: '{{ range .Alerts.Resolved }}{{ .Annotations.summary }}\n{{ end }}'

    email_configs:
      - to: '${ON_CALL_EMAIL}'
        from: 'alerts@meetly.ovh'
        smarthost: '${SMTP_SERVER}:${SMTP_PORT}'
        auth_username: '${SMTP_USER}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: '[üö® CRITIQUE] {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: red;">üö® ALERTE CRITIQUE</h2>
          <p><strong>Service:</strong> {{ .GroupLabels.service }}</p>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          {{ range .Alerts }}
          <hr>
          <p><strong>{{ .Annotations.summary }}</strong></p>
          <p>{{ .Annotations.description }}</p>
          <p><em>Time: {{ .StartsAt }}</em></p>
          {{ end }}

  # ===== OPS TEAM (Slack - Warnings) =====
  - name: ops-team
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts'
        title: '‚ö†Ô∏è ALERTE PROD'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        color: 'warning'

  # ===== PREPROD TEAM =====
  - name: preprod-team
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#preprod-alerts'
        title: 'üì¢ Alerte Pr√©production'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ end }}
        send_resolved: true
        color: 'good'

  # ===== SSL TEAM (Email) =====
  - name: ssl-team
    email_configs:
      - to: '${DEVOPS_EMAIL}'
        from: 'alerts@meetly.ovh'
        smarthost: '${SMTP_SERVER}:${SMTP_PORT}'
        auth_username: '${SMTP_USER}'
        auth_password: '${SMTP_PASSWORD}'
        headers:
          Subject: '[SSL] {{ .GroupLabels.alertname }}'
        html: |
          <h2>üîí Alerte Certificat SSL</h2>
          {{ range .Alerts }}
          <p><strong>{{ .Annotations.summary }}</strong></p>
          <p>{{ .Annotations.description }}</p>
          {{ end }}
          <p><a href="https://grafana.exam.meetly.ovh/d/ssl">Voir les certificats</a></p>

  # ===== INFO CHANNEL =====
  - name: info-channel
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#monitoring'
        title: '‚ÑπÔ∏è √âv√©nement Monitoring'
        text: |
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ end }}
        send_resolved: true

  # ===== DEFAULT (ne devrait pas √™tre atteint) =====
  - name: default
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#monitoring'
        title: 'üîî Alerte'
        text: 'Alerte non classifi√©e'

inhibit_rules:
  # Inhiber les warnings si la m√™me instance a une alerte critique
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['instance', 'service']

  # Inhiber les info si m√™me component en warning/critical
  - source_match_re:
      severity: 'warning|critical'
    target_match:
      severity: 'info'
    equal: ['component']

